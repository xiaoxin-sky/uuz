{"version":3,"file":"uuz.js","sources":["../src/index.js"],"sourcesContent":["let targetMap = new WeakMap();\r\nlet activeEffect;\r\n\r\nfunction update(el, instance) {\r\n  el.innerHTML = instance.render()\r\n}\r\n\r\nfunction effect(fn, options = {}) {\r\n  const _effect = function(...args) {\r\n    activeEffect = _effect;\r\n    return fn(...args);\r\n  };\r\n  /* computed相关 */\r\n  if (!options.lazy) {\r\n    _effect();\r\n  }\r\n  _effect.options = options;\r\n  return _effect;\r\n}\r\n\r\nfunction track(target, key) {\r\n  let depsMap = targetMap.get(target);\r\n  if (!depsMap) {\r\n\t\ttargetMap.set(target, (depsMap = new Map()));\r\n  }\r\n  let dep = depsMap.get(key);\r\n\tif (!dep) {\r\n    depsMap.set(key, (dep = new Set()));\r\n  }\r\n  if (!dep.has(activeEffect)) {\r\n    dep.add(activeEffect);\r\n\t}\r\n}\r\n\r\nfunction trigger(target, key) {\r\n  const depsMap = targetMap.get(target);\r\n  if (!depsMap) return;\r\n  const effects = new Set()\r\n  depsMap.get(key).forEach(e => effects.add(e))\r\n  effects.forEach(e => scheduleRun(e))\r\n}\r\n\r\n\r\nfunction scheduleRun(effect) {\r\n  if (effect.options.scheduler !== void 0) {\r\n    effect.options.scheduler();\r\n  } else {\r\n    effect();\r\n  }\r\n}\r\n\r\nfunction mount(instance, el) {\r\n  effect(function() {\r\n    instance.$data && update(el, instance);\r\n  })\r\n  instance.$data = instance.setup();\r\n  update(el, instance);\r\n}\r\n\r\nfunction reactive(target) {\r\n  return new Proxy(target, {\r\n    get(target, prop) {\r\n      track(target, prop);\r\n      return Reflect.get(target, prop);\r\n    },\r\n    set(target, prop, newVal) {\r\n      Reflect.set(target, prop, newVal);\r\n      trigger(target, prop);\r\n      /* \r\n        必须 return true;\r\n        否则会产生警告 'set' on proxy: trap returned falsish for property\r\n      */\r\n      return true;\r\n    }\r\n  })\r\n}\r\n\r\nfunction ref(target) {\r\n  let value = target\r\n\r\n  const obj = {\r\n    get value() {\r\n      track(obj, 'value');\r\n      return value;\r\n    },\r\n    set value(newVal) {\r\n      if (newVal !== value) {\r\n        value = newVal;\r\n        trigger(obj, 'value');\r\n      }\r\n    }\r\n  }\r\n\r\n  return obj;\r\n}\r\n\r\nfunction computed(fn) {\r\n  let dirty = true;\r\n  let value;\r\n\r\n  const runner = effect(fn, {\r\n    lazy: true,\r\n    scheduler: () => {\r\n      dirty = true;\r\n    }\r\n  });\r\n  return {\r\n    get value() {\r\n      if (dirty) {\r\n        dirty = false;\r\n        value = runner();\r\n      }\r\n      return value;\r\n    }\r\n  };\r\n}\r\n\r\n\r\nexport {\r\n  mount,\r\n  reactive,\r\n  ref,\r\n  computed\r\n}"],"names":["activeEffect","targetMap","WeakMap","update","el","instance","innerHTML","render","effect","fn","options","_effect","args","lazy","track","target","key","depsMap","get","set","Map","dep","Set","has","add","trigger","effects","forEach","e","scheduler","scheduleRun","value","dirty","runner","$data","setup","Proxy","prop","Reflect","newVal","obj"],"mappings":"iMAAA,IACIA,EADAC,EAAY,IAAIC,QAGpB,SAASC,EAAOC,EAAIC,GAClBD,EAAGE,UAAYD,EAASE,SAG1B,SAASC,EAAOC,EAAIC,EAAU,UACtBC,EAAU,YAAYC,UAC1BZ,EAAeW,EACRF,KAAMG,WAGVF,EAAQG,MACXF,IAEFA,EAAQD,QAAUA,EACXC,EAGT,SAASG,EAAMC,EAAQC,OACjBC,EAAUhB,EAAUiB,IAAIH,GACvBE,GACLhB,EAAUkB,IAAIJ,EAASE,EAAU,IAAIG,SAEjCC,EAAMJ,EAAQC,IAAIF,GAClBK,GACFJ,EAAQE,IAAIH,EAAMK,EAAM,IAAIC,KAEzBD,EAAIE,IAAIvB,IACXqB,EAAIG,IAAIxB,GAIZ,SAASyB,EAAQV,EAAQC,SACjBC,EAAUhB,EAAUiB,IAAIH,OACzBE,EAAS,aACRS,EAAU,IAAIJ,IACpBL,EAAQC,IAAIF,GAAKW,QAAQC,GAAKF,EAAQF,IAAII,IAC1CF,EAAQC,QAAQC,GAIlB,SAAqBpB,QACc,IAA7BA,EAAOE,QAAQmB,UACjBrB,EAAOE,QAAQmB,YAEfrB,IARmBsB,CAAYF,eAyDnC,SAAkBnB,OAEZsB,EADAC,GAAQ,QAGNC,EAASzB,EAAOC,EAAI,CACxBI,MAAM,EACNgB,UAAW,KACTG,GAAQ,WAGL,oBAECA,IACFA,GAAQ,EACRD,EAAQE,KAEHF,aA7Db,SAAe1B,EAAUD,GACvBI,GAAO,WACLH,EAAS6B,OAAS/B,EAAOC,EAAIC,MAE/BA,EAAS6B,MAAQ7B,EAAS8B,QAC1BhC,EAAOC,EAAIC,eAGb,SAAkBU,UACT,IAAIqB,MAAMrB,EAAQ,CACvBG,IAAG,CAACH,EAAQsB,KACVvB,EAAMC,EAAQsB,GACPC,QAAQpB,IAAIH,EAAQsB,IAE7BlB,IAAG,CAACJ,EAAQsB,EAAME,KAChBD,QAAQnB,IAAIJ,EAAQsB,EAAME,GAC1Bd,EAAQV,EAAQsB,IAKT,YAKb,SAAatB,OACPgB,EAAQhB,QAENyB,EAAM,oBAER1B,EAAM0B,EAAK,SACJT,aAECQ,GACJA,IAAWR,IACbA,EAAQQ,EACRd,EAAQe,EAAK,mBAKZA"}