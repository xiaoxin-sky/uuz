{"version":3,"file":"uuz.js","sources":["../src/utils/base.js","../src/core/h.js","../src/core/reactive.js","../src/core/dom.js"],"sourcesContent":["export const isArr = Array.isArray;\nexport const isFn = (fn) => typeof fn === 'function';\nexport const isStr = (v) => typeof v === 'string';\nexport const isText = (v) => typeof v === 'string' || typeof v === 'number';\n\nexport const isStuff = (v) => v !== null && v !== false && v !== true;","import { isStuff, isText } from '../utils/base.js';\n\nconst createElement = function (type, attrs, ...children) {\n  console.log(type, attrs, children, 'xxx')\n  let props = attrs || {};\n  let key = props.key || null\n  let ref = props.ref || null\n\n  delete props.key\n  delete props.ref\n\n  const childrenElement = [].concat(...children).reduce((list, child) => {\n    if (isStuff(child)) {\n      const vnode = isText(child) ? createText(child) : child;\n      list.push(vnode);\n    }\n    return list;\n  }, [])\n\n  props.children = childrenElement;\n  return { type, props, key, ref };\n}\n\nconst createText = (text) => {\n  return {\n    type: 'text',\n    props: {\n      children: [],\n      content: text,\n    }\n  }\n}\n\n/* \n  在vue3中没有了 createElement取而代之的是 createBlock 和 createVNode\n\n  createBlock主要比createVNode多生成一个dynamicChildren\n*/\n\n\nexport {\n  createElement\n}","\nlet targetMap = new WeakMap();\nlet activeEffect;\n\nfunction effect(fn, options = {}) {\n  const _effect = function(...args) {\n    activeEffect = _effect;\n    return fn(...args);\n  };\n  /* computed相关 */\n  if (!options.lazy) {\n    _effect();\n  }\n  /* \n    options 比如：scheduler\n  */\n  _effect.options = options;\n  return _effect;\n}\n\nfunction track(target, key) {\n  let depsMap = targetMap.get(target);\n  if (!depsMap) {\n\t\ttargetMap.set(target, (depsMap = new Map()));\n  }\n  let dep = depsMap.get(key);\n\tif (!dep) {\n    depsMap.set(key, (dep = new Set()));\n  }\n  if (!dep.has(activeEffect)) {\n    dep.add(activeEffect);\n\t}\n}\n\nfunction trigger(target, key) {\n  const depsMap = targetMap.get(target);\n  if (!depsMap) return;\n  const effects = new Set()\n  depsMap.get(key).forEach(e => effects.add(e))\n  effects.forEach(e => scheduleRun(e))\n}\n\nfunction scheduleRun(effect) {\n  if (effect.options.scheduler !== void 0) {\n    effect.options.scheduler(effect);\n  } else {\n    effect();\n  }\n}\n\nfunction reactive(target) {\n  return new Proxy(target, {\n    get(target, prop) {\n      track(target, prop);\n      return Reflect.get(target, prop);\n    },\n    set(target, prop, newVal) {\n      Reflect.set(target, prop, newVal);\n      trigger(target, prop);\n      /* \n        必须 return true;\n        否则会产生警告 'set' on proxy: trap returned falsish for property\n      */\n      return true;\n    }\n  })\n}\n\nfunction ref(target) {\n  let value = target\n\n  const obj = {\n    get value() {\n      track(obj, 'value');\n      return value;\n    },\n    set value(newVal) {\n      if (newVal !== value) {\n        value = newVal;\n        trigger(obj, 'value');\n      }\n    }\n  }\n\n  return obj;\n}\n\nfunction computed(fn) {\n  let dirty = true;\n  let value;\n  let _computed;\n\n  const runner = effect(fn, {\n    lazy: true,\n    scheduler: (e) => {\n      if (!dirty) {\n        dirty = true;\n        trigger(_computed, 'value');\n      }\n    }\n  });\n  \n  _computed = {\n    get value() {\n      if (dirty) {\n        value = runner();\n        dirty = false;\n      }\n      track(_computed, 'value');\n      return value;\n    }\n  }\n  return _computed;\n}\n\n\nexport {\n  reactive,\n  ref,\n  effect,\n  computed\n}","import { isFn } from '../utils/base.js';\nimport { effect } from './reactive';\n\nconst createApp = (rootComponent) => {\n  const app = {\n    mount(rootDom) {\n      render(rootComponent, rootDom);\n    },\n  };\n  return app;\n};\n\nfunction render(instance, dom, oldDom) {\n  effect(function() {\n    if (!instance.active) {\n      instance.$data = instance.setup();\n      instance.active = true;\n    }\n    let vnode = instance.render(instance.$data);\n    // const vnode = instance.type();\n    diff(vnode, dom, oldDom || dom.firstChild);\n  })\n}\n\nconst diff = (vnode, dom, oldDom) => {\n  // 获得在创建元素是的vnode\n  let oldVnode = oldDom && oldDom.vnode;\n  if (!oldDom) {\n    mount(vnode, dom, oldDom);\n  } else if (isFn(vnode.type)) {\n    diffComponent(vnode, null, dom, oldDom);\n  } else if (oldVnode && oldVnode.type === vnode.type) {\n    diffElement(oldDom, vnode, oldVnode);\n  } else {\n    // TODO: \n    console.log('不值得比较了')\n  }\n}\n\nconst diffComponent = (vnode, oldVnode, dom, oldDom) => {\n  if (!oldVnode) {\n    mount(vnode, dom, oldDom);\n  }\n}\n\nconst diffElement = (oldDom, vnode, oldVnode) => {\n  if (oldVnode.type === 'text') {\n    updateTextNode(oldDom, vnode, oldVnode);\n  } else {\n    updateElement(oldDom, vnode, oldVnode);\n  }\n\n  oldDom.vnode = vnode;\n\n  vnode.props.children.forEach((child, i) => {\n    // children:只包含元素节点\n    // childNodes:包含所有类型的节点\n    // 这时需要在h函数中剔除undefined元素\n    diff(child, oldDom, oldDom.childNodes[i]);\n  })\n\n  // 试图剔除多余节点 childNodes\n  let oldChildNodes = oldDom.childNodes;\n  let oldMaxIndex = oldChildNodes.length - 1; \n  let vnodeMaxIndex = vnode.props.children.length - 1;\n  // 剔除多余节点\n  if (oldMaxIndex > vnodeMaxIndex) {\n    // 从后面开始删除，保证index顺序\n    for (let i = oldMaxIndex; i > vnodeMaxIndex; i--) {\n      unmountNode(oldDom, oldChildNodes[i]);\n    }\n  }\n}\n\nconst mount = (vnode, dom, oldDom) => {\n  if (isFn(vnode.type)) {\n    return mountComponent(vnode, dom, oldDom);\n  } else {\n    return mountElement(vnode, dom, oldDom);\n  }\n}\n\nconst mountComponent = (vnode, dom, oldDom) => {\n  // resetHook(vnode, dom, oldDom);\n  let nextVnode = vnode;\n  while (isFn(nextVnode.type)) {\n    nextVnode = nextVnode.type((vnode.props || {}));\n  }\n  return mount(nextVnode, dom, oldDom);\n}\n\nconst mountElement = (vnode, dom, oldDom, parent) => {\n  /*\n    在 h 函数中已经将数组扁平化\n    在处理 map 等jsx 的时候不需要再通过再次判断数组递归\n  */\n\n  let newDom = null;\n  const nextSibiling = oldDom && oldDom.nextSibiling;\n\n  if (vnode.type === 'text') {\n    newDom = document.createTextNode(vnode.props.content);\n  } else {\n    newDom = document.createElement(vnode.type);\n    updateElement(newDom, vnode)\n  }\n\n  // 生成元素的的时候顺便造一颗vnode树\n  newDom.vnode = vnode;\n\n  if (oldDom) {\n    unmountNode(parent, oldDom);\n  }\n\n  if (nextSibiling) {\n    dom.insertBefore(newDom, nextSibiling);\n  } else {\n    dom.appendChild(newDom);\n  }\n\n  vnode.props.children.forEach(child => {\n    mount(child, newDom);\n  })\n}\n\nconst updateElement = (dom, newVnode, oldVnode = {}) => {\n  const newProps = newVnode.props || {};\n  const oldProps = oldVnode.props || {};\n\n  // 将新旧属性同时比较以减少遍历次数\n  for (let name in { ...oldProps, ...newProps }) {\n    let oldValue = oldProps[name]\n    let newValue = newProps[name]\n\n    if (oldValue == newValue || name === 'children') {\n    } else if (name === 'style') {\n      // TODO: style\n    } else if (name === 'className') {\n      dom.setAttribute('class', newValue);\n    } else if (name.startsWith('on')) {\n      const eventName = name.slice(2).toLowerCase();\n      if (oldValue) dom.removeEventListener(eventName, oldValue, false);\n      dom.addEventListener(eventName, newValue, false);\n    } else if (newValue == null || newValue === false) {\n      dom.removeAttribute(name)\n    } else {\n      dom.setAttribute(name, newValue)\n    }\n  }\n}\n\nconst updateTextNode = (dom, newVnode, oldVnode = {}) => {\n  if (newVnode.props.content !== oldVnode.props.content) {\n    dom.textContent = newVnode.props.content;\n  }\n  dom.vnode = newVnode;\n}\n\nconst unmountNode = (dom, child) => {\n  child.remove();\n}\n\nexport {\n  createApp,\n  render\n}"],"names":["isFn","fn","createText","text","type","props","children","content","activeEffect","targetMap","WeakMap","effect","options","_effect","args","lazy","track","target","key","depsMap","get","set","Map","dep","Set","has","add","trigger","effects","forEach","e","scheduler","scheduleRun","render","instance","dom","oldDom","active","$data","setup","vnode","diff","firstChild","oldVnode","diffComponent","diffElement","console","log","mount","updateTextNode","updateElement","child","i","childNodes","oldChildNodes","oldMaxIndex","length","vnodeMaxIndex","unmountNode","mountComponent","mountElement","nextVnode","parent","newDom","nextSibiling","document","createTextNode","createElement","insertBefore","appendChild","newVnode","newProps","oldProps","name","oldValue","newValue","setAttribute","startsWith","eventName","slice","toLowerCase","removeEventListener","addEventListener","removeAttribute","textContent","remove","value","_computed","dirty","runner","rootComponent","rootDom","attrs","ref","childrenElement","concat","reduce","list","v","isText","push","Proxy","prop","Reflect","newVal","obj"],"mappings":"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"}